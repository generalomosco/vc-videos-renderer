/*! For license information please see vc-videos-renderer.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}(self,(()=>(()=>{var e={"./src/VcVideosRenderer.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>s});var i=r("./src/vcVideosRendererCore.js");const o={debug:!1,frameRate:30};class n extends i.default{constructor(e,t){super(e,t=Object.assign({},o,t))}getMixedStream(){return this._getMixedStream()}stopDrawing(){return this._stopDrawing()}startDrawing(){return this._startDrawing()}resetFrame(e){return this._resetFrame(e)}updateExistingItems(e){return this._updateExistingItems(e)}softUpdateVideoFrameItem(e,{objectFit:t,renderVideo:r,renderAudio:i,cameraDisabled:o,audioDisabled:n,isWaiting:s,isReconnecting:a,backgroundColor:d,borderColor:c,innerBorderColor:h}){return this._softUpdateVideoFrameItem(e,{objectFit:t,renderVideo:r,renderAudio:i,cameraDisabled:o,audioDisabled:n,isWaiting:s,isReconnecting:a,backgroundColor:d,borderColor:c,innerBorderColor:h})}destroy(){this._destroy()}}const s=n},"./src/core-extenstions/imageRenderer/ImageRenderer.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>s});var i=r("./src/extension.js"),o=r("./src/core-extenstions/imageRenderer/Img.js");class n extends i.default{constructor(e){super(e)}NewImageFromTextures(e,t,r){return new o.default(this,"texture",e,t,r)}NewImageFromURLs(e,t,r){return new o.default(this,"url",e,t,r)}}const s=n},"./src/core-extenstions/imageRenderer/Img.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>n});var i=r("./src/utils/GLHelpers.js");const o={x:0,y:0,objectFit:"contain",borderRadius:0,backgroundColor:[0,0,0,0],borderColor:[0,0,0,0],borderWidth:0,borderSoftness:1,innerBorder:{borderColor:[0,0,0,0],borderWidth:0},gif:{isGif:!1,frameRate:30}};class n{constructor(e,t,r,i,n){this.imageRenderer=e,this.sourceType=t,this.sources=r,this.style=Object.assign({},o,i),this.style.innerBorder=Object.assign({},o.innerBorder,i.innerBorder??{}),this.style.gif=Object.assign({},o.gif,i.gif??{}),this.gifState={groups:{}},this.texturesObj={toRenderID:null,textures:[]},this._isReady=!1,this._onReadyCb=n,this._setupTexture()}_setupTexture(){"texture"===this.sourceType?this._setupRendering(this.sources):"url"===this.sourceType?this._loadTexturesFromURLs(this.sources).then((e=>{this._setupRendering(e)})).catch((e=>{e.source&&e.source.URL?this.imageRenderer.app.console.error(`Error loading image from URL "${e.source.URL}"`,e.error):this.imageRenderer.app.console.error(e)})):this.imageRenderer.app.console.error(`Invalid image source type "${this.sourceType}"!`)}_loadTexturesFromURLs(e){return new Promise(((t,r)=>{const i=[];for(const t in e){const r=e[t];this.style.gif.isGif&&(r.gifIndex=Number(t)),i.push(new Promise(((e,t)=>{this.imageRenderer.app.loadTextureAsset({URL:r.URL,cacheID:r.cacheID},((i,o)=>{if(o)return t({source:r,error:o});e({source:r,texture:i})}))})))}if(!i.length)return r("Empty image source!");Promise.all(i).then((e=>{const r=[];for(const t of e){const e={id:t.source.id,texture:t.texture};t.source.hasOwnProperty("gifIndex")&&(e.gifIndex=t.source.gifIndex),r.push(e)}t(r)})).catch((e=>{r(e)}))}))}_setupRendering(e){const t=[];for(const r in e){const i=e[r];if(!i.texture||!["image"].includes(i.texture.type)||!i.texture.image)return void this.imageRenderer.app.console.error("Invalid texture!");i.id||0===i.id||(i.id="-auto-gen-texture-id--"+this.imageRenderer.app.generateIncreamentID()),this.style.gif.isGif&&(i.gifIndex||0===i.gifIndex||(i.gifIndex=Number(r))),t.push(i)}this.style.gif.isGif&&t.sort((function(e,t){return e.gifIndex-t.gifIndex}));let r=null;1===t.length&&(r=t[0].id),this.texturesObj={toRenderID:r,textures:t},this._isReady=!0,this._onReadyCb&&(this._onReadyCb(),this._onReadyCb=null)}isItReady(){return this._isReady}update({width:e,height:t,x:r,y:i,borderWidth:o,borderRadius:n,borderSoftness:s,toRenderID:a}={}){void 0!==e&&(this.style.width=e),void 0!==t&&(this.style.height=t),void 0!==r&&(this.style.x=r),void 0!==i&&(this.style.y=i),void 0!==o&&(this.style.borderWidth=o),void 0!==n&&(this.style.borderRadius=n),void 0!==s&&(this.style.borderSoftness=s),void 0!==a&&(this.texturesObj.toRenderID=a)}render({gifGroupName:e,gifSessionKey:t,gifRandomizeInitialization:r=!1}={}){const i=this.texturesObj.textures.length;if(i)if(this.style.gif.isGif){e||0===e||(e="default");let o=this.gifState.groups[e];o||(o={startTime:window.performance.now(),nextRenderIndex:0,gifSessionKey:null},this.gifState.groups[e]=o),o.gifSessionKey!==t&&(o.gifSessionKey=t,o.nextRenderIndex=r?n.generateRandomInt(0,i-1):0);const s=window.performance.now()-o.startTime,a=1e3/this.style.gif.frameRate,d=Math.floor(s/a);o.nextRenderIndex=(o.nextRenderIndex+d)%i,this._render(o.nextRenderIndex),o.startTime+=d*a}else for(const e in this.texturesObj.textures)if(this.texturesObj.textures[e].id===this.texturesObj.toRenderID){this._render(e);break}}_render(e){const t=this.texturesObj.textures[e];if(!t)return;const r=this.imageRenderer.app;(this.style.borderWidth||0!==this.style.backgroundColor[3])&&r.drawRectBackgroundsAndBorders({width:this.style.width,height:this.style.height,x:this.style.x,y:this.style.y,borderWidth:this.style.borderWidth,borderColor:this.style.borderColor,backgroundColor:this.style.backgroundColor,borderRadius:this.style.borderRadius,borderSoftness:this.style.borderSoftness},!1);const o=t.texture.image,n=t.texture.texture;r.gl.useProgram(r.shaders.kinds.image.program),r.gl.bindTexture(r.gl.TEXTURE_2D,n),r.gl.pixelStorei(r.gl.UNPACK_FLIP_Y_WEBGL,1),r.gl.texImage2D(r.gl.TEXTURE_2D,0,r.gl.RGBA,r.gl.RGBA,r.gl.UNSIGNED_BYTE,o);const s=(0,i.createBuffer)(r.gl,(0,i.calculateVerticesPosition)(r.canvas,{x:this.style.x,y:this.style.y,objectFit:this.style.objectFit,width:this.style.width,height:this.style.height,borderWidth:this.style.borderWidth,imageWidth:o.width,imageHeight:o.height}),r.gl.ARRAY_BUFFER);if((0,i.setBufferData)(r.gl,r.shaders.kinds.image.attributes.rectVertexPosition,s),r.gl.uniform2fv(r.shaders.kinds.image.uniforms.u_resolution,[r.canvas.width,r.canvas.height]),this.style.borderWidth||this.style.innerBorder.borderWidth){let e=this.style.x,t=this.style.y,i=this.style.width,o=this.style.height,n=this.style.borderRadius,s=0;if(n&&(n+=2),n&&!this.style.borderWidth&&this.style.innerBorder.borderWidth){const r=2;i-=r,o-=r,e+=r/2,t+=r/2,n-=r}this.style.borderWidth&&(this.style.borderSoftness&&(s=this.style.borderSoftness/2,i-=s,o-=s,e+=s/2,t+=s/2),e+=this.style.borderWidth,t+=this.style.borderWidth,i-=2*this.style.borderWidth,o-=2*this.style.borderWidth,n&&(n-=this.style.borderWidth)),r.gl.uniform2fv(r.shaders.kinds.image.uniforms.rect_u_size,[i,o]),r.gl.uniform2fv(r.shaders.kinds.image.uniforms.rect_u_location,[e,t]),r.gl.uniform1f(r.shaders.kinds.image.uniforms.rect_u_borderWidth,0),r.gl.uniform1f(r.shaders.kinds.image.uniforms.rect_u_borderSoftness,0),r.gl.uniform4fv(r.shaders.kinds.image.uniforms.rect_u_borderColor,[0,0,0,0]),r.gl.uniform4fv(r.shaders.kinds.image.uniforms.rect_u_borderRadius,[n,n,n,n])}else r.gl.uniform2fv(r.shaders.kinds.image.uniforms.rect_u_size,[this.style.width,this.style.height]),r.gl.uniform2fv(r.shaders.kinds.image.uniforms.rect_u_location,[this.style.x,this.style.y]),r.gl.uniform1f(r.shaders.kinds.image.uniforms.rect_u_borderWidth,0),r.gl.uniform1f(r.shaders.kinds.image.uniforms.rect_u_borderSoftness,this.style.borderSoftness),r.gl.uniform4fv(r.shaders.kinds.image.uniforms.rect_u_borderColor,[0,0,0,0]),r.gl.uniform4fv(r.shaders.kinds.image.uniforms.rect_u_borderRadius,[this.style.borderRadius,this.style.borderRadius,this.style.borderRadius,this.style.borderRadius]);r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),this.style.innerBorder.borderWidth&&this.style.innerBorder.borderColor&&r.drawRectBackgroundsAndBorders({width:this.style.width,height:this.style.height,x:this.style.x,y:this.style.y,parentBorderWidth:this.style.borderWidth,borderWidth:this.style.innerBorder.borderWidth,borderColor:this.style.innerBorder.borderColor,backgroundColor:[0,0,0,0],borderRadius:this.style.borderRadius,borderSoftness:this.style.borderSoftness},!0)}destroy(e=!1){if(e)for(const e of this.texturesObj.textures)this.imageRenderer.app.unlinkTextureCache(e.texture)}static generateRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}}},"./src/core-extenstions/textRenderer/Text.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>o});const i={hyphenateWord:!0,compactText:!1,fontSize:12,lineHeight:4,fontWeight:"normal",textColor:[1,0,0,1],backgroundColor:[0,1,0,1],borderRadius:[0,0,0,0],padding:[5,5],xDirection:"left",yDirection:"top",x:10,y:10,icon:{iconURL:null,iconCacheID:null,width:10,height:10,placeIcon:"left",fromTextToIconPadding:10},floatingText:{float:!1,speed:20}};class o{constructor(e,t,r,o){this.textRenderer=e,this.text=t,this.textStyle=Object.assign({},i,r),this.textStyle.icon=Object.assign({},i.icon,r.icon??{}),this.textStyle.floatingText=Object.assign({},i.floatingText,r.floatingText??{}),this.TheImageRenderer=null,this.iconTexture=null,this._isReady=!1,this.floatableItems=null,this.nonFloatableTextProp=null,this._createTextTexture(o)}_createTextTexture(e){this.textStyle.icon.iconURL?this.textRenderer.app.loadTextureAsset({URL:this.textStyle.icon.iconURL,cacheID:this.textStyle.icon.iconCacheID},((t,r)=>{if(r)return this.textRenderer.app.console.error(`Error loading image from URL "${this.textStyle.icon.iconURL}"`,r),void this._createText(null,e);this._createText(t.image,e)})):this._createText(null,e)}_createText(e,t){const r=document.createElement("canvas").getContext("2d");r.canvas.width=1,r.canvas.height=1,this.textStyle.floatingText.float&&(this.floatableItems={frame:{width:this.textRenderer.app.canvas.width,height:this.textRenderer.app.canvas.height},height:0,items:[]},this.textStyle.hyphenateWord=!1,this.textStyle.compactText=!0,this.textStyle.maxLine=null,this.textStyle.icon.iconURL=null);const i=e=>{e.fillStyle=o.normalizeRGB_RGBA_Array_To_255_String(this.textStyle.textColor),e.font=`${this.textStyle.fontWeight} ${this.textStyle.fontSize}px Arial`,e.textAlign="left",e.textBaseline="top"};i(r);let n=this.textStyle.maxWidth-2*this.textStyle.padding[1];this.textStyle.icon.iconURL&&(n-=this.textStyle.icon.width+this.textStyle.icon.fromTextToIconPadding);const s=o.calculateTextViewInCanvas(r,this.text,0,0,{maxWidth:n,maxLine:this.textStyle.maxLine,lineHeight:this.textStyle.lineHeight,compactText:this.textStyle.compactText,hyphenateWord:this.textStyle.hyphenateWord});this.textStyle.floatingText.float&&(s.width=s.highest_line_width,s.height=s.highest_line_height);let a=this.textStyle.padding[1],d=this.textStyle.padding[0],c=this.textStyle.padding[1],h=this.textStyle.padding[0];if(this.textStyle.icon.iconURL){r.canvas.width=s.width+2*this.textStyle.padding[1]+this.textStyle.icon.width+this.textStyle.icon.fromTextToIconPadding;let e=null;s.height>this.textStyle.icon.height?(e=s.height,h+=(s.height-this.textStyle.icon.height)/2):(e=this.textStyle.icon.height,d+=(this.textStyle.icon.height-s.height)/2),r.canvas.height=e+2*this.textStyle.padding[0],"right"===this.textStyle.icon.placeIcon?c+=s.width+this.textStyle.icon.fromTextToIconPadding:a+=this.textStyle.icon.width+this.textStyle.icon.fromTextToIconPadding}else r.canvas.width=s.width+2*this.textStyle.padding[1],r.canvas.height=s.height+2*this.textStyle.padding[0];t&&t({width:r.canvas.width,height:r.canvas.height,textStyle:this.textStyle});const l=e=>{e.beginPath(),e.roundRect(0,0,e.canvas.width,e.canvas.height,this.textStyle.borderRadius),e.fillStyle=o.normalizeRGB_RGBA_Array_To_255_String(this.textStyle.backgroundColor),e.fill()};l(r),e&&r.drawImage(e,c,h,this.textStyle.icon.width,this.textStyle.icon.height),i(r);let u=s.lines.shift(),m=-1,f={firstItem:null,items:[]};if(this.textStyle.floatingText.float){const e=document.createElement("canvas").getContext("2d");e.canvas.width=this.floatableItems.frame.width,e.canvas.height=r.canvas.height,l(e),f.items.push({id:m,canvas:e.canvas}),this.floatableItems.items.push({id:m,width:e.canvas.width,height:e.canvas.height})}for(;void 0!==u;){if(m++,this.textStyle.floatingText.float)if(0===m)this.floatableItems.height=r.canvas.height,f.firstItem=u,f.items.push({id:m,canvas:r.canvas}),this.floatableItems.items.push({id:m,width:r.canvas.width,height:r.canvas.height}),r.fillText(u.line,u.x+a,u.y+d);else{const e=document.createElement("canvas").getContext("2d");e.canvas.width=u.width,e.canvas.height=r.canvas.height,l(e),i(e),e.fillText(u.line,0,f.firstItem.y+d),f.items.push({id:m,canvas:e.canvas}),this.floatableItems.items.push({id:m,width:e.canvas.width,height:e.canvas.height})}else r.fillText(u.line,u.x+a,u.y+d);u=s.lines.shift()}if(f.items.length>1){m++;const e=document.createElement("canvas").getContext("2d");e.canvas.width=this.floatableItems.frame.width,e.canvas.height=r.canvas.height,l(e),f.items.push({id:m,canvas:e.canvas}),this.floatableItems.items.push({id:m,width:e.canvas.width,height:e.canvas.height})}this.textStyle.floatingText.float?this._loadURLsFromCanvases(f.items).then((e=>{let t=this.textStyle.x;"right"===this.textStyle.xDirection&&(t-=r.canvas.width);let i=this.textStyle.y;"bottom"===this.textStyle.yDirection&&(i-=r.canvas.height),this.TheImageRenderer=this.textRenderer.app.ImageRenderer.NewImageFromURLs(e,{width:r.canvas.width,height:r.canvas.height,x:t,y:i},(()=>{this._isReady=!0}))})).catch((e=>{this.textRenderer.app.console.error("Failed to create text ",e)})):(this.nonFloatableTextProp={width:r.canvas.width,height:r.canvas.height},o.canvasToStringUrl(r.canvas).then((e=>{this.textRenderer.app.loadTextureAsset({URL:e},((e,t)=>{if(t)throw t;let i=this.textStyle.x;"right"===this.textStyle.xDirection&&(i-=r.canvas.width);let o=this.textStyle.y;"bottom"===this.textStyle.yDirection&&(o-=r.canvas.height),this.TheImageRenderer=this.textRenderer.app.ImageRenderer.NewImageFromTextures([{id:1,texture:e}],{width:r.canvas.width,height:r.canvas.height,x:i,y:o},(()=>{this._isReady=!0}))}))})).catch((e=>{this.textRenderer.app.console.error(e)})))}_loadURLsFromCanvases(e){return new Promise(((t,r)=>{const i=[];for(const t in e){const r=e[t];i.push(new Promise(((e,t)=>{o.canvasToStringUrl(r.canvas).then((t=>{e({item:r,URL:t})})).catch((e=>{t({item:r,error:e})}))})))}if(!i.length)return r("Empty text canvas!");Promise.all(i).then((e=>{const r=[];for(const t of e){const e={id:t.item.id,URL:t.URL};r.push(e)}t(r)})).catch((e=>{r(e)}))}))}_updateNonFloatableTextXY(){if(this.textStyle.floatingText.float||!this.nonFloatableTextProp||!this.TheImageRenderer)return;let e=this.textStyle.x;"right"===this.textStyle.xDirection&&(e-=this.nonFloatableTextProp.width);let t=this.textStyle.y;"bottom"===this.textStyle.yDirection&&(t-=this.nonFloatableTextProp.height),this.TheImageRenderer.update({x:e,y:t})}update({x:e,y:t}={}){this.textStyle.floatingText.float||(void 0!==e&&(this.textStyle.x=e),void 0!==t&&(this.textStyle.y=t),void 0===e&&void 0===t||this._updateNonFloatableTextXY())}render(){if(this.TheImageRenderer)if(this.textStyle.floatingText.float){if(!this._isReady)return;if(!this.floatableItems._state){this.floatableItems._state={total_width:0,moving_x:-(this.floatableItems.frame.width-100),speedMoveStep:null,appFrameRate:this.textRenderer.app.frameRate};for(const e of this.floatableItems.items)this.floatableItems._state.total_width+=e.width}const e=this.floatableItems._state;let t=this.textStyle.y;if("bottom"===this.textStyle.yDirection&&(t-=this.floatableItems.height),null===e.speedMoveStep||e.appFrameRate!==this.textRenderer.app.frameRate){e.appFrameRate=this.textRenderer.app.frameRate;const t=window.performance.now(),r=t-(t-1e3/this.textRenderer.app.frameRate),i=1e3/this.textStyle.floatingText.speed;e.speedMoveStep=r/i}e.moving_x-=e.speedMoveStep,e.total_width+e.moving_x<=this.floatableItems.frame.width&&(e.moving_x=0);let r=e.moving_x,i=0,o=r;for(const e of this.floatableItems.items){i+=e.width;const n=i+r;n>0&&(this.floatableItems.frame.width>=n||o>0&&this.floatableItems.frame.width>=o)&&(this.TheImageRenderer.update({toRenderID:e.id,width:e.width,height:e.height,x:n-e.width,y:t}),this.TheImageRenderer.render()),o=n}}else this.TheImageRenderer.render()}static canvasToStringUrl(e){return new Promise(((t,r)=>{try{t(e.toDataURL())}catch(e){r(e)}}))}static calculateTextViewInCanvas(e,t,r,i,{maxWidth:n,maxLine:s,lineHeight:a,compactText:d,hyphenateWord:c}){const h=i,l={width:0,height:0,highest_line_width:0,highest_line_height:0,lines:[]};let u=!1,m=!1,f=!1;1===s&&(m=!0);let g=0,_=null;const x=(t,o,d)=>{if(m&&!d)return g++,_={line:t,isUserNewLine:o},void(u=!0);if(d&&!m)return;if(d&&null===_)return;d?(t=_.line,o=_.isUserNewLine,f&&(t.line=t.line.trimEnd(),t.line+="...")):g++,o||(t.line=t.line.trimStart()),t.line=t.line.trimEnd();const c=e.measureText(t.line),x={x:r,y:i,line:t.line,isWordBreakAtEnd:t.isWordBreakAtEnd,height:0,width:0},p=c.actualBoundingBoxAscent+c.actualBoundingBoxDescent;x.width=c.width,x.height=p,l.width>l.highest_line_height&&(l.highest_line_height=p),i+=p,a&&(i+=a),c.width>n?l.width=n:c.width>l.width&&(l.width=c.width),l.width>l.highest_line_width&&(l.highest_line_width=l.width),l.height=Math.abs(h-i),s&&s===g+1&&(m=!0),l.lines.push(x)},p=t.split("\n");let v=p.shift(),y=null;for(;void 0!==v;){if(u){f=!0;break}let t=null;const r=v.split(" ");let i=r.shift();for(y=!0;void 0!==i;){if(u){i=void 0,t=null,f=!0;break}let s="";s=null===t?i:t+" "+i;let a=s;m&&(a+="...");const h=e.measureText(a).width;if(h>n){let a=!0,l=t??i;if(d&&(l=s),d||1===l.split(" ").length){let s=h;if(!d){let t="";m&&(t="..."),s=e.measureText(l+t).width}if(s>n){a=!1,d?t=null:null!==t&&(r.unshift(i),t=null);const s=[...l];let h="",u=0,f=s.shift(),g=!1;for(;void 0!==f;){const t=o.charsContainAlphabet(f);if(u){let i="";if(m?i="...":c?t&&g&&(i="-"):i="",e.measureText(h+f+i).width>n){m&&(i=""),x({isWordBreakAtEnd:!0,line:h+i},y),y=!1,h=null,s.unshift(f),r.unshift(s.join(""));break}}h+=f,u++,g=t,f=s.shift()}}else a=!0}if(a){let e="";null===t?e=i:(e=t,t=i),x({line:e},y),y=!1}}else t=s;i=r.shift(),d||void 0!==i||null===t||e.measureText(t).width>n&&(i=t,t=null)}null!==t&&x({line:t},y),v=p.shift()}return x(null,null,!0),a&&l.height&&(l.height-=a),l}static charsContainAlphabet(e){return"string"==typeof e&&null!==e.match(/\p{L}/gu)}static normalizeRGB_RGBA_Array_To_255_String(e){return e&&e.length?e<=3?`rgb(${255*e[0]}, ${255*(e[1]??0)}, ${255*(e[2]??0)})`:`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${e[3]})`:"rgb(0, 0, 0)"}destroy(e=!1){this.TheImageRenderer&&this.TheImageRenderer.destroy(e)}}},"./src/core-extenstions/textRenderer/TextRenderer.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>s});var i=r("./src/extension.js"),o=r("./src/core-extenstions/textRenderer/Text.js");class n extends i.default{constructor(e){super(e)}NewText(e,t,r){return new o.default(this,e,t,r)}}const s=n},"./src/event-handle.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>o});var i=document;!function(){function e(e,t){var r=document.createEvent("CustomEvent");return t=t||{bubbles:!1,cancelable:!1,detail:void 0},r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}"function"!=typeof window.EventHandle&&(e.prototype=window.Event.prototype,window.EventHandle=e)}();class o{constructor(e){this.eventPrefix="vc-videos-renderer-event--"+e}on(e,t){return"string"==typeof e?i.addEventListener(this.eventPrefix+e,t):e.forEach((e=>{i.addEventListener(this.eventPrefix+e,t)})),{remove:()=>{"string"==typeof e?i.removeEventListener(this.eventPrefix+e,t):e.forEach((e=>{i.removeEventListener(this.eventPrefix+e,t)}))}}}once(e,t){return i.addEventListener(this.eventPrefix+e,t,{once:!0}),{remove:()=>{i.removeEventListener(this.eventPrefix+e,t)}}}off(e,t){i.removeEventListener(this.eventPrefix+e,t)}fire(e,t){!function(e,t){var r=new EventHandle(e,{detail:t});i.dispatchEvent(r)}(this.eventPrefix+e,t)}}},"./src/extension.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>a});var i=r("./src/VcVideosRenderer.js");const o={},n=(e,t)=>(t.prototype.name=e,function(...e){return new t(...[this,...e])});class s{constructor(e){if(this.constructor===s)throw new Error("Invalid Extension!");this.app=e}static addExtension(e,t){if("string"!=typeof t)throw new Error(`Extension name must be a type string "${t}"!`);if(!t)throw new Error("Extension must have a name!");if(o[t]||i.default.prototype.hasOwnProperty(t))throw new Error(`Found existing extension same name with "${t}"!`);if("function"!=typeof e)throw new Error(`"${t}" must be a type function!`);return o[t]=e,i.default.prototype._extensions[t]=n(t,e),e}}s.addExtension(s,"extension");const a=s},"./src/index.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>a});var i=r("./src/VcVideosRenderer.js"),o=r("./src/extension.js"),n=r("./src/core-extenstions/imageRenderer/ImageRenderer.js"),s=r("./src/core-extenstions/textRenderer/TextRenderer.js");i.default.Extension=o.default,o.default.addExtension(n.default,"ImageRenderer"),o.default.addExtension(s.default,"TextRenderer"),window.VcVideosRenderer=i.default;const a=i.default},"./src/logs/VCVRDEnum.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});const i={unsupported:{code:"unsupported",message:"Unsupported"},unsupported_webgl:{code:"unsupported-webgl",message:"Your browser does not support WebGL!"},drawing_already_progress:{code:"drawing-already-progress",message:"Drawing is already in progress."},no_such_extension_found:{code:"no-such-extension-found",message:"No such extension found!"},vcVideosRenderer_already_destroyed:{code:"vcVideosRenderer_already_destroyed",message:"VC Videos Renderer has already be destroyed!"}}},"./src/logs/VCVRDError.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});class i extends Error{constructor(e,{code:t}){super(e),this._vCVRDError_params={code:t}}get vCVRDErrorCode(){return this._vCVRDError_params.code}static NewErrorFromEnumItem(e){return new i(e.message,{code:e.code})}}},"./src/utils/CaptureMediaStreamFromMediaElement.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>o});var i=r("./src/utils/CustomAnimationFrameRunner.js");class o extends MediaStream{#e=null;#t=null;#r=30;#i=null;#o=["video","audio"];constructor(e,t){super(),window._vcvrdr_CMSFME_WeakMaps||(window._vcvrdr_CMSFME_WeakMaps={video:new WeakMap,audio:new WeakMap}),this.#e=window._vcvrdr_CMSFME_WeakMaps,this.#t=e,Array.isArray(t)&&(this.#o=t),this.#n()}#n(){const e=e=>{this.#o.includes(e.kind)&&super.addTrack(e)};if("captureStream"in this.#t)return this.#i=this.#t.captureStream(),void this.#i.getTracks().forEach((t=>e(t)));if(this.#o.includes("video")){let t=this.#e.video.get(this.#t);if(t||(t={canvasCtx:document.createElement("canvas").getContext("2d"),references:[],destroyed:!1,isDrawing:!1,_unlinkRef:null,_destroy:null,MediaStreamTrackVideo:null,GetClonedVideoTrack:null,AnimationFrameRunner:new i.default,ref:{_canplay:null,_do_render:null,_startDrawing:null,_pauseDrawing:null}},t.MediaStreamTrackVideo=t.canvasCtx.canvas.captureStream().getVideoTracks()[0],t._do_render=()=>{if(t.destroyed)throw"The Video MediaStreamTrack has already been destroyed!";t.canvasCtx.canvas.width=this.#t.videoWidth,t.canvasCtx.canvas.height=this.#t.videoHeight,t.canvasCtx.drawImage(this.#t,0,0,t.canvasCtx.canvas.width,t.canvasCtx.canvas.height)},t._startDrawing=()=>{if(t.destroyed)throw"The Video MediaStreamTrack has already been destroyed!";t.isDrawing||(t.isDrawing=!0,t.AnimationFrameRunner.start((()=>t._do_render()),this.#r))},t._stopDrawing=()=>{t.AnimationFrameRunner.stop(),t.isDrawing=!1},t._canplay=()=>{t.isDrawing||t._do_render()},this.#t.paused||t._startDrawing(),this.#t.addEventListener("canplay",t._canplay),this.#t.addEventListener("pause",t._pauseDrawing),this.#t.addEventListener("ended",t._pauseDrawing),this.#t.addEventListener("play",t._startDrawing),this.#t.readyState>=1&&t._canplay(),t._destroy=()=>{t.destroyed||(this.#t.removeEventListener("canplay",t._canplay),this.#t.removeEventListener("pause",t._pauseDrawing),this.#t.removeEventListener("ended",t._pauseDrawing),this.#t.removeEventListener("play",t._startDrawing),t._stopDrawing(),t.destroyed=!0,this.#e.video.delete(this.#t))},this.#e.video.set(this.#t,t)),t._unlinkRef=e=>{for(const r in t.references)if(t.references[r]===e){o.#s(t.references,r);break}t.references.length||t._destroy()},t.getClonedVideoTrack=()=>{if(t.destroyed)throw"The Video MediaStreamTrack has already been destroyed!";window._CMSFME_vidmst_increment_id||(window._CMSFME_vidmst_increment_id=0);const e="id-"+window._CMSFME_vidmst_increment_id++;t.references.push(e);const r=t.MediaStreamTrackVideo.clone();return r.addEventListener("ended",(()=>{t._unlinkRef(e)})),r},t){const r=t.getClonedVideoTrack();e(r)}}if(this.#o.includes("audio")){let t=this.#e.audio.get(this.#t);if(!t){t={audioContext:new AudioContext,audioGain:null,sourceNode:null,destination:null,MediaStreamTrackAudio:null,processedAudioElement:null},t.destination=t.audioContext.createMediaStreamDestination(),t.audioGain=t.audioContext.createGain(),t.audioGain.connect(t.destination),t.sourceNode=t.audioContext.createMediaElementSource(this.#t),t.sourceNode.connect(t.audioGain),t.audioContext.resume();const e=t.destination.stream.getAudioTracks();t.MediaStreamTrackAudio=e[0],t.processedAudioElement=new Audio,t.processedAudioElement.srcObject=new MediaStream(e),t.processedAudioElement.play(),this.#e.audio.set(this.#t,t)}if(t){const r=t.MediaStreamTrackAudio.clone();e(r)}}}stop(){super.getTracks().forEach((e=>{e.stop(),e.dispatchEvent(new Event("ended"))})),this.#i&&this.#i.getTracks().forEach((e=>e.stop()))}static#s(e,t){t=Number(t),!e.length||e.length<t+1||e.splice(t,1)}}},"./src/utils/Common.js":(e,t,r)=>{"use strict";function i(e,t,r=[0,0,0,0]){const[i,o]=t.split(":").map(Number);return(e-(r[0]+r[2]))*i/o+(r[1]+r[3])}function o(e,t,r=[0,0,0,0]){const[i,o]=t.split(":").map(Number);return(e-(r[1]+r[3]))*o/i+(r[0]+r[2])}function n(e,t){t=Number(t),!e.length||e.length<t+1||e.splice(t,1)}r.r(t),r.d(t,{calculateHeightFromRatio:()=>o,calculateWidthFromRatio:()=>i,deleteIndex:()=>n})},"./src/utils/CustomAnimationFrameRunner.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});class i{#a=30;#d=null;#c=null;constructor(){this.#h()}start(e,t=this.#a){this.#c=e,this.#d.postMessage({start:!0,fps:t})}stop(){this.#d.postMessage({start:!1}),this.#c=null}#h(){let e=(()=>{let e=!1,t=null,r=0;self.onmessage=function({data:{start:i,fps:o=30}}){i?(t=1e3/o,r=0,(()=>{if(e)return;e=!0;const i=()=>{if(!e)return;const o=performance.now();o-r>=t?(r=o,self.postMessage({currentTime:o}),requestAnimationFrame(i)):requestAnimationFrame(i)};i()})()):e=!1}}).toString();e=e.substring(e.indexOf("{")+1,e.lastIndexOf("}"));const t=URL.createObjectURL(new Blob([e],{type:"application/javascript"}));this.#d=new Worker(t),this.#d.onmessage=({data:{currentTime:e}})=>{try{this.#c(e)}catch(e){throw this.stop(),e}}}}},"./src/utils/GLHelpers.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{calculateVerticesPosition:()=>h,createBuffer:()=>s,createProgram:()=>n,createRectVertices:()=>c,createShader:()=>o,createTexture:()=>d,setBufferData:()=>a});var i=r("./src/utils/Common.js");function o(e,t,r){const i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||(console.log("shader not compiled!"),console.log(e.getShaderInfoLog(i))),i}function n(e,t,r){const i=e.createProgram();return e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.useProgram(i),i}function s(e,t,r){const i=e.createBuffer();return e.bindBuffer(r,i),e.bufferData(r,t,e.STATIC_DRAW),i}function a(e,t,r){e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t)}function d(e){const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t}function c(e,{x:t,y:r,width:i,height:o,borderWidth:n}){let s=t,a=r,d=i,c=o;n&&(s-=n,a-=n,d+=2*n,c+=2*n);const h=s,l=h+d,u=a,m=u+c,f=e.width/window.devicePixelRatio,g=e.height/window.devicePixelRatio,_=h/f*2-1,x=l/f*2-1,p=1-u/g*2,v=1-m/g*2;return new Float32Array([_,p,x,p,_,v,x,v])}function h(e,{x:t,y:r,objectFit:o,width:n,height:s,borderWidth:a,imageWidth:d,imageHeight:c}){if(a?(t+=a,r+=a,n-=2*a,s-=2*a):a=0,"contain"===o){let o=t,h=r,l=n,u=s;d>c&&l>u||d<c&&l>u?(l=(0,i.calculateWidthFromRatio)(u,d+":"+c,[a,a,a,a]),o+=(n-l)/2):(u=(0,i.calculateHeightFromRatio)(l,d+":"+c,[a,a,a,a]),h+=(s-u)/2);const m=o,f=m+l,g=h,_=g+u,x=e.width/window.devicePixelRatio,p=e.height/window.devicePixelRatio,v=m/x*2-1,y=f/x*2-1,b=1-g/p*2,R=1-_/p*2;return new Float32Array([v,b,y,b,v,R,y,R])}if("cover"===o){let o=t,h=r,l=n,u=s;d>c&&l>u||d<c&&l>u?(u=(0,i.calculateHeightFromRatio)(l,d+":"+c,[a,a,a,a]),h+=(s-u)/2):(l=(0,i.calculateWidthFromRatio)(u,d+":"+c,[a,a,a,a]),o+=(n-l)/2);const m=o,f=m+l,g=h,_=g+u,x=e.width/window.devicePixelRatio,p=e.height/window.devicePixelRatio,v=m/x*2-1,y=f/x*2-1,b=1-g/p*2,R=1-_/p*2;return new Float32Array([v,b,y,b,v,R,y,R])}{const i=t,o=i+n,a=r,d=a+s,c=e.width/window.devicePixelRatio,h=e.height/window.devicePixelRatio,l=i/c*2-1,u=o/c*2-1,m=1-a/h*2,f=1-d/h*2;return new Float32Array([l,m,u,m,l,f,u,f])}}},"./src/vcVideosRendererCore.js":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>p});var i=r("./src/logs/VCVRDEnum.js"),o=r("./src/logs/VCVRDError.js"),n=r("./src/event-handle.js"),s=r("./node_modules/raw-loader/dist/cjs.js!./src/shaders/rounded-rect-border-entry-point.frag"),a=r("./asset/vc-videos-renderer/images/muted-mic.png"),d=r("./asset/vc-videos-renderer/images/default-avatar.png"),c=r("./asset/vc-videos-renderer/images/default-reconnecting-avatar.png"),h=r("./env.json"),l=r("./src/utils/CustomAnimationFrameRunner.js"),u=r("./src/utils/GLHelpers.js"),m=r("./src/utils/Common.js"),f=r("./src/utils/CaptureMediaStreamFromMediaElement.js"),g=1;class _{constructor(e,t){this.extState={},this.options=t,this.debug=this.options.debug,this.frameRate=this.options.frameRate,this.canvas=e,this.console=this.console(),this.appID="vc-videos-renderer_"+this.generateIncreamentID(),this.session={},this.Event=new n.default(this.appID),this.gl=null,this.itemsToMergerList=[],this.audioItemsToMergerList=[],this.isDrawing=!1,this.AnimationFrameRunner=new l.default,this.shaders=null,this.ImageRenderer=null,this.TextRenderer=null,this.MediaStream=null,this.MediaStreamTrackVideo=null,this.MediaAudio=null,this.MediaStreamTrackAudio=null,this.destroyed=!1,this._cachedTextures={fetchingCaches:[],caches:[]},this.waiting_animation_ImageRenderer=null,this._initDefaultEvent()}generateIncreamentID(){return g++}_getMixedStream(){return this.MediaStream}_initDefaultEvent(){this._initWebGL();const e=[];for(let t=0;t<55;t++){const r=`${h.publicPath}asset/vc-videos-renderer/images/gif/waiting/waiting-100x54-${t}.png`;e.push({URL:r})}this.waiting_animation_ImageRenderer=this.ImageRenderer.NewImageFromURLs(e,{gif:{isGif:!0,frameRate:30},width:100,height:54,x:200,y:200,objectFit:"contain",borderSoftness:0})}_resetFrame(e,t){const r={};for(const i of this.itemsToMergerList)if(t){for(const t of e)if(t.id===i.id){r[i.id]=i;break}}else r[i.id]=i;const i=[];for(const o in e){const n=e[o];let s=r[n.id];if(!t||s){if("video"===n.type){const e={type:n.type,id:n.id,videoElement:n.videoElement,renderVideo:n.renderVideo,renderAudio:n.renderAudio,cameraDisabled:n.cameraDisabled,audioDisabled:n.audioDisabled,displayName:n.displayName,isWaiting:n.isWaiting??!1,isReconnecting:n.isReconnecting??!1,isVideoReady:!1,reconnectingAvatarURL:n.reconnectingAvatarURL?n.reconnectingAvatarURL:c.default,avatarURL:n.avatarURL?n.avatarURL:d.default,width:n.width,height:n.height,x:n.x,y:n.y,objectFit:n.objectFit,borderRadius:n.borderRadius,backgroundColor:n.backgroundColor,borderColor:n.borderColor,borderWidth:n.borderWidth,borderSoftness:n.borderSoftness??2,innerBorder:{borderColor:n.innerBorder?.borderColor,borderWidth:n.innerBorder?.borderWidth},_mitem_state:{Reconnecting_ImageRenderer:null,DisplayName_TextRenderer:null,videoTexture:null}};this._addEventToVideo(e);let t=!1,o=!1,h=!1;s&&"video"===s.type?(delete r[n.id],this._removeEventFromVideo(s),this._compareObjectsProperties(s,e,[{key1:"width",key2:"width"},{key1:"height",key2:"height"},{key1:"borderWidth",key2:"borderWidth"}])&&(t=!0),this._compareObjectsProperties(s,e,[{key1:"x",key2:"x"},{key1:"y",key2:"y"}])&&(o=!0),this._compareObjectsProperties(s,e,[{key1:"borderRadius",key2:"borderRadius"}])&&(h=!0)):s=null,s&&s._mitem_state.videoTexture?(e._mitem_state.videoTexture=s._mitem_state.videoTexture,s._mitem_state.videoTexture=null):e._mitem_state.videoTexture=(0,u.createTexture)(this.gl),s&&s.waitingDimension&&t&&o?e.waitingDimension=s.waitingDimension:(e.waitingDimension={width:20,height:0,x:0,y:0,sessionKey:this.generateIncreamentID()},e.width>300&&(e.waitingDimension.width=30),e.waitingDimension.height=(0,m.calculateHeightFromRatio)(e.waitingDimension.width,"100:54"),e.waitingDimension.x=Math.abs(e.x+(e.width/2-e.waitingDimension.width/2)),e.waitingDimension.y=Math.abs(e.y+(e.height/2-e.waitingDimension.height/2)));{const r=()=>{let t=null;t=e.width>e.height?e.height-(e.borderWidth??0)-30:e.width-(e.borderWidth??0)-30,t+2>300&&(t=298);const r=t/2;return{avatarSize:t,x:Math.abs(e.x+(e.width/2-t/2)),y:Math.abs(e.y+(e.height/2-t/2)),borderRadius:r,borderWidth:2,borderSoftness:2}};if(s&&e.avatarURL===s.avatarURL&&t&&o)e._mitem_state.Avatar_ImageRenderer=s._mitem_state.Avatar_ImageRenderer,s._mitem_state.Avatar_ImageRenderer=null;else if(!s||e.avatarURL!==s.avatarURL||t&&o){if(e.avatarURL){const t=r();e._mitem_state.Avatar_ImageRenderer=this.ImageRenderer.NewImageFromURLs([{URL:e.avatarURL,cacheID:e.avatarURL}],{width:t.avatarSize,height:t.avatarSize,x:t.x,y:t.y,objectFit:"cover",backgroundColor:[0,0,0,0],borderColor:[0,.78,1,.4],borderWidth:t.borderWidth,borderRadius:t.borderRadius,borderSoftness:t.borderSoftness})}}else if(s._mitem_state.Avatar_ImageRenderer){const t=r();s._mitem_state.Avatar_ImageRenderer.update({width:t.avatarSize,height:t.avatarSize,x:t.x,y:t.y,borderWidth:t.borderWidth,borderRadius:t.borderRadius,borderSoftness:t.borderSoftness}),e._mitem_state.Avatar_ImageRenderer=s._mitem_state.Avatar_ImageRenderer,s._mitem_state.Avatar_ImageRenderer=null}s&&s._mitem_state.Avatar_ImageRenderer&&(s._mitem_state.Avatar_ImageRenderer.destroy(s.avatarURL!==d.default),s._mitem_state.Avatar_ImageRenderer=null)}s&&e.displayName===s.displayName&&t&&h&&o?(e._mitem_state.DisplayName_TextRenderer=s._mitem_state.DisplayName_TextRenderer,s._mitem_state.DisplayName_TextRenderer=null):s&&e.displayName===s.displayName&&t&&h&&!o?s._mitem_state.DisplayName_TextRenderer&&(s._mitem_state.DisplayName_TextRenderer.update({x:e.x+e.width-(e.borderWidth??0),y:e.y+e.height-(e.borderWidth??0)}),e._mitem_state.DisplayName_TextRenderer=s._mitem_state.DisplayName_TextRenderer,s._mitem_state.DisplayName_TextRenderer=null):e.displayName&&(e._mitem_state.DisplayName_TextRenderer=this.TextRenderer.NewText(e.displayName,{maxWidth:e.width-(e.borderWidth??0)-20,maxLine:1,fontSize:12,fontWeight:"bold",textColor:[.9,.9,.9,1],backgroundColor:[0,0,0,.6],padding:[5,10],borderRadius:[0,0,e.borderRadius,0],xDirection:"right",yDirection:"bottom",x:e.x+e.width-(e.borderWidth??0),y:e.y+e.height-(e.borderWidth??0)})),s&&s._mitem_state.DisplayName_TextRenderer&&(s._mitem_state.DisplayName_TextRenderer.destroy(),s._mitem_state.DisplayName_TextRenderer=null),s&&e.displayName===s.displayName&&t&&h&&o?(e._mitem_state.DisplayName_WithMutedMic_TextRenderer=s._mitem_state.DisplayName_WithMutedMic_TextRenderer,s._mitem_state.DisplayName_WithMutedMic_TextRenderer=null):s&&e.displayName===s.displayName&&t&&h&&!o?s._mitem_state.DisplayName_WithMutedMic_TextRenderer&&(s._mitem_state.DisplayName_WithMutedMic_TextRenderer.update({x:e.x+e.width-(e.borderWidth??0),y:e.y+e.height-(e.borderWidth??0)}),e._mitem_state.DisplayName_WithMutedMic_TextRenderer=s._mitem_state.DisplayName_WithMutedMic_TextRenderer,s._mitem_state.DisplayName_WithMutedMic_TextRenderer=null):e._mitem_state.DisplayName_WithMutedMic_TextRenderer=this.TextRenderer.NewText(e.displayName??"",{maxWidth:e.width-(e.borderWidth??0)-20,maxLine:1,fontSize:12,fontWeight:"bold",textColor:[.9,.9,.9,1],backgroundColor:[0,0,0,.6],padding:[5,10],borderRadius:[0,0,e.borderRadius,0],xDirection:"right",yDirection:"bottom",x:e.x+e.width-(e.borderWidth??0),y:e.y+e.height-(e.borderWidth??0),icon:{iconURL:a.default,iconCacheID:a.default,placeIcon:"right",fromTextToIconPadding:10,width:15,height:20}}),s&&s._mitem_state.DisplayName_WithMutedMic_TextRenderer&&(s._mitem_state.DisplayName_WithMutedMic_TextRenderer.destroy(),s._mitem_state.DisplayName_WithMutedMic_TextRenderer=null),this._initVideoReconnecting(e,{isNewUpdate:!0,old_mergeItem:s}),i.push(e)}else if("text"===n.type){const e={type:n.type,id:n.id,text:n.text,floatingText:n.floatingText,maxWidth:n.maxWidth,maxLine:n.maxLine,fontSize:n.fontSize,fontWeight:n.fontWeight,textColor:n.textColor,backgroundColor:n.backgroundColor,padding:n.padding,borderRadius:n.borderRadius,xDirection:n.xDirection,yDirection:n.yDirection,x:n.x,y:n.y,hyphenateWord:n.hyphenateWord,compactText:n.compactText,icon:n.icon,_mitem_state:{TextItemRenderer:null}};let t=!1;s&&"text"===s.type?(delete r[n.id],this._compareObjectsProperties(s,e,[{sameKeys:["text","floatingText","maxWidth","maxLine","fontSize","fontWeight","textColor","backgroundColor","padding","borderRadius","xDirection","yDirection","x","y","hyphenateWord","compactText","icon"]}])&&(t=!0)):s=null,t?(e._mitem_state.TextItemRenderer=s._mitem_state.TextItemRenderer,s._mitem_state.TextItemRenderer=null):e._mitem_state.TextItemRenderer=this.TextRenderer.NewText(e.text,{floatingText:e.floatingText,maxWidth:e.maxWidth,maxLine:e.maxLine,fontSize:e.fontSize,fontWeight:e.fontWeight,textColor:e.textColor,backgroundColor:e.backgroundColor,padding:e.padding,borderRadius:e.borderRadius,xDirection:e.xDirection,yDirection:e.yDirection,x:e.x,y:e.y,hyphenateWord:e.hyphenateWord,compactText:e.compactText,icon:e.icon}),i.push(e)}}else this.console.warn(`No frame item as id "${n.id}" for update!`)}if(t){const e={};for(const t of i)e[t.id]=t;for(const t in this.itemsToMergerList){const r=this.itemsToMergerList[t];e[r.id]&&(this.itemsToMergerList[t]=e[r.id])}}else this.itemsToMergerList=i;this._resetAudioTracks(i,t);for(const e in r){const t=r[e];t&&"video"===t.type&&(this._removeEventFromVideo(t),t._mitem_state.Avatar_ImageRenderer&&t._mitem_state.Avatar_ImageRenderer.destroy(t.avatarURL!==d.default),t._mitem_state.DisplayName_TextRenderer&&t._mitem_state.DisplayName_TextRenderer.destroy(),t._mitem_state.DisplayName_WithMutedMic_TextRenderer&&t._mitem_state.DisplayName_WithMutedMic_TextRenderer.destroy(),t._mitem_state.Reconnecting_ImageRenderer&&t._mitem_state.Reconnecting_ImageRenderer.destroy(t.reconnectingAvatarURL!==c.default))}}_addEventToVideo(e){"video"===e.type&&(e._mitem_state._VideoCanplayEventCb=()=>{(()=>{let t=!0;return e.videoElement.srcObject&&!e.videoElement.srcObject.getVideoTracks().length&&(t=!1),t})()?e.isVideoReady=!0:e.isVideoReady=!1},e.videoElement.addEventListener("canplay",e._mitem_state._VideoCanplayEventCb),e.videoElement.readyState>=1&&e._mitem_state._VideoCanplayEventCb())}_removeEventFromVideo(e){"video"===e.type&&(e.videoElement.removeEventListener("canplay",e._mitem_state._VideoCanplayEventCb),e._mitem_state._VideoCanplayEventCb=null)}_updateExistingItems(e){this._resetFrame(e,!0)}_softUpdateVideoFrameItem(e,{objectFit:t,renderVideo:r,renderAudio:i,cameraDisabled:o,audioDisabled:n,isWaiting:s,isReconnecting:a,backgroundColor:d,borderColor:c,innerBorderColor:h}){let l=!1;for(const u of this.itemsToMergerList){if(u.id!==e)continue;if("video"!==u.type)return void this.console.warn(`The video id "${e}" does not match the existing video type!`);let m=!1;void 0!==t&&(u.objectFit=t),void 0!==r&&(u.renderVideo=r),void 0!==i&&(m=!0,u.renderAudio=i),void 0!==o&&(u.cameraDisabled=o),void 0!==n&&(m=!0,u.audioDisabled=n),void 0!==s&&(u.isWaiting=s),void 0!==a&&(u.isReconnecting=a),void 0!==d&&(u.backgroundColor=d),void 0!==c&&(u.borderColor=c),void 0!==h&&u.innerBorder&&(u.innerBorder.borderColor=h),m&&this._resetAudioTracks([u],!0),l=!0;break}l||this.console.warn(`No video item with id "${e}" matches any of the existing videos!`)}_initVideoReconnecting(e,{isNewUpdate:t,old_mergeItem:r}={}){if(t){if(!r||"video"!==r.type)return;if(e.reconnectingAvatarURL!==r.reconnectingAvatarURL&&(r._mitem_state.Reconnecting_ImageRenderer&&(r._mitem_state.Reconnecting_ImageRenderer.destroy(r.reconnectingAvatarURL!==c.default),r._mitem_state.Reconnecting_ImageRenderer=null),!e.isReconnecting))return}if(!t&&("video"!==e.type||e._mitem_state.Reconnecting_ImageRenderer))return;const i=e.reconnectingAvatarURL;let o=e.x,n=e.y,s=e.width,a=e.height,d=e.borderRadius;if(e.borderWidth||e.innerBorder&&e.innerBorder.borderWidth){if(d&&(d+=2),d&&!e.borderWidth&&e.innerBorder&&e.innerBorder.borderWidth){const e=2;s-=e,a-=e,o+=e/2,n+=e/2,d-=e}let t=0;e.borderWidth&&(e.borderSoftness&&(t=e.borderSoftness/2,s-=t,a-=t,o+=t/2,n+=t/2),o+=e.borderWidth,n+=e.borderWidth,s-=2*e.borderWidth,a-=2*e.borderWidth,d&&(d-=e.borderWidth))}t&&r._mitem_state.Reconnecting_ImageRenderer?(r._mitem_state.Reconnecting_ImageRenderer.update({width:s,height:a,x:o,y:n,borderRadius:d}),e._mitem_state.Reconnecting_ImageRenderer=r._mitem_state.Reconnecting_ImageRenderer,r._mitem_state.Reconnecting_ImageRenderer=null):e._mitem_state.Reconnecting_ImageRenderer=this.ImageRenderer.NewImageFromURLs([{URL:i,cacheID:i}],{width:s,height:a,x:o,y:n,objectFit:"cover",borderRadius:d,borderSoftness:0})}_stopDrawing(){this.AnimationFrameRunner.stop(),this.isDrawing=!1}async _startDrawing(){if(this.destroyed)throw o.default.NewErrorFromEnumItem(i.default.vcVideosRenderer_already_destroyed);if(this.isDrawing)throw o.default.NewErrorFromEnumItem(i.default.drawing_already_progress);this._initMediaAudio();const e=this.frameRate;this.isDrawing=!0,this.AnimationFrameRunner.start((()=>this._render()),e)}_resetAudioTracks(e,t){if(!this.MediaAudio)return;const r={};for(const i of this.audioItemsToMergerList)if(t){for(const t of e)if(t.id===i.id){r[i.id]=i;break}}else r[i.id]=i;const i=[];for(const o in e){const n=e[o];let s=r[n.id];if((!t||s)&&"video"===n.type){const e={type:n.type,id:n.id,videoElement:n.videoElement,renderAudio:n.renderAudio,audioDisabled:n.audioDisabled,_mitem_state:{capturedStream:null,sourceProp:null,MixedAudioMediaStreamGainNode:null,MixedAudioMediaStreamSourceNode:null}};s&&"video"===s.type?delete r[n.id]:s=null;let t=null;if(e.videoElement.srcObject)t=e.videoElement.srcObject;else if(s&&s.videoElement===e.videoElement&&s._mitem_state.sourceProp&&s._mitem_state.capturedStream)t=s._mitem_state.capturedStream,e._mitem_state.capturedStream=t;else if(!s||s&&s.videoElement!==e.videoElement)try{t=new f.default(e.videoElement,["audio"]),e._mitem_state.capturedStream=t}catch(e){this.console.warn("Error capturing MediaStream videoElement!",e)}if(s&&s._mitem_state.sourceProp&&(t&&s._mitem_state.sourceProp.fromMediaStream?(e._mitem_state.MixedAudioMediaStreamSourceNode=s._mitem_state.MixedAudioMediaStreamSourceNode,e._mitem_state.MixedAudioMediaStreamGainNode=s._mitem_state.MixedAudioMediaStreamGainNode,e._mitem_state.sourceProp=s._mitem_state.sourceProp,e._mitem_state.fromMediaStream=s._mitem_state.fromMediaStream,e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream.getTracks().forEach((r=>{let i=!1;for(const e of t.getTracks())if(r===e&&"audio"===e.kind){i=!0;break}i||e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream.removeTrack(r)})),e._mitem_state.sourceProp.fromMediaStream.hasAudioTrack=!1,t.getTracks().forEach((t=>{if("audio"!==t.kind)return;e._mitem_state.sourceProp.fromMediaStream.hasAudioTrack=!0;let r=!1;for(const i of e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream.getTracks())if(i===t){r=!0;break}r||e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream.addTrack(t)})),s._mitem_state.capturedStream&&t!==s._mitem_state.capturedStream&&s._mitem_state.capturedStream.stop()):this._disconnectAudio(s)),!e._mitem_state.sourceProp&&t&&(e._mitem_state.sourceProp={fromMediaStream:{hasAudioTrack:!1,mixedAudioMediaStream:new MediaStream}},t.getTracks().filter((function(e){return"audio"===e.kind})).forEach((t=>{e._mitem_state.sourceProp.fromMediaStream.hasAudioTrack=!0,e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream.addTrack(t)})),e._mitem_state.sourceProp.fromMediaStream.hasAudioTrack))try{e._mitem_state.MixedAudioMediaStreamSourceNode=this.MediaAudio.audioContext.createMediaStreamSource(e._mitem_state.sourceProp.fromMediaStream.mixedAudioMediaStream),e._mitem_state.MixedAudioMediaStreamGainNode=this.MediaAudio.audioContext.createGain(),e._mitem_state.MixedAudioMediaStreamGainNode.gain.value=1,e._mitem_state.MixedAudioMediaStreamSourceNode.connect(e._mitem_state.MixedAudioMediaStreamGainNode),e._mitem_state.MixedAudioMediaStreamGainNode.connect(this.MediaAudio.mixerGain)}catch(e){this.console.warn("Failed creating audioContext sourceNode.",e)}i.push(e)}}if(t){const e={};for(const t of i)e[t.id]=t;for(const t in this.audioItemsToMergerList){const r=this.audioItemsToMergerList[t];e[r.id]&&(this.audioItemsToMergerList[t]=e[r.id])}}else this.audioItemsToMergerList=i;for(const e in r){const t=r[e];if(!t)return;this._disconnectAudio(t)}}_disconnectAudio(e){if(e&&"video"===e.type&&(e._mitem_state.capturedStream&&(this.console.log("capturedStream",e._mitem_state.capturedStream),e._mitem_state.capturedStream.stop()),e._mitem_state.MixedAudioMediaStreamSourceNode))try{e._mitem_state.MixedAudioMediaStreamGainNode.disconnect(this.MediaAudio.mixerGain),e._mitem_state.MixedAudioMediaStreamSourceNode.disconnect(e._mitem_state.MixedAudioMediaStreamGainNode)}catch(e){this.console.warn(e)}}_initMediaAudio(){this.MediaAudio||(this.MediaAudio={audioContext:new AudioContext,mixerGain:null,destination:null},this.MediaAudio.mixerGain=this.MediaAudio.audioContext.createGain(),this.MediaAudio.destination=this.MediaAudio.audioContext.createMediaStreamDestination(),this.MediaAudio.mixerGain.connect(this.MediaAudio.destination),this.MediaAudio.audioContext.resume(),this.MediaStreamTrackAudio=this.MediaAudio.destination.stream.getAudioTracks()[0],this.MediaStream.addTrack(this.MediaStreamTrackAudio),this._resetAudioTracks(this.itemsToMergerList))}_initWebGL(){if(this.gl=this.canvas.getContext("webgl2",{alpha:!1}),!this.gl)throw o.default.NewErrorFromEnumItem(i.default.unsupported_webgl);this.MediaStream=this.canvas.captureStream(),this.MediaStreamTrackVideo=this.MediaStream.getVideoTracks()[0],this.ImageRenderer=this.GetExtension("ImageRenderer").New(),this.TextRenderer=this.GetExtension("TextRenderer").New(),this.shaders={kinds:{}},this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);const e=_.createImageShaderProgram(this.gl),t=Math.floor((this.canvas.width-this.canvas.width*window.devicePixelRatio)/2),r=Math.floor((this.canvas.height-this.canvas.height*window.devicePixelRatio)/2);this.gl.viewport(t,r,this.canvas.width*window.devicePixelRatio,this.canvas.height*window.devicePixelRatio);const n=new Float32Array([-1,1,1,1,-1,-1,1,-1]),s=new Float32Array([0,1,1,1,0,0,1,0]),a=this.gl.getAttribLocation(e,"aVertexPosition"),d=this.gl.getAttribLocation(e,"aUv"),c=(0,u.createBuffer)(this.gl,n,this.gl.ARRAY_BUFFER),h=(0,u.createBuffer)(this.gl,s,this.gl.ARRAY_BUFFER);(0,u.setBufferData)(this.gl,a,c),(0,u.setBufferData)(this.gl,d,h);const l=this.gl.getUniformLocation(e,"uSampler");this.gl.uniform1i(l,0);const m=this.gl.getUniformLocation(e,"uScale");this.gl.uniform4fv(m,[1/window.devicePixelRatio,1/window.devicePixelRatio,0,1]);const f=this.gl.getUniformLocation(e,"u_resolution"),g=this.gl.getUniformLocation(e,"rect_u_size"),x=this.gl.getUniformLocation(e,"rect_u_borderWidth"),p=this.gl.getUniformLocation(e,"rect_u_borderSoftness"),v=this.gl.getUniformLocation(e,"rect_u_borderRadius"),y=this.gl.getUniformLocation(e,"rect_u_borderColor"),b=this.gl.getUniformLocation(e,"rect_u_location");this.shaders.kinds.image={program:e,attributes:{rectVertexPosition:a},uniforms:{u_resolution:f,rect_u_size:g,rect_u_borderWidth:x,rect_u_borderSoftness:p,rect_u_borderRadius:v,rect_u_borderColor:y,rect_u_location:b}},this.shaders.kinds.video={program:e,attributes:{rectVertexPosition:a},uniforms:{u_resolution:f,rect_u_size:g,rect_u_borderWidth:x,rect_u_borderSoftness:p,rect_u_borderRadius:v,rect_u_borderColor:y,rect_u_location:b}};const R=_.createBorderShaderProgram(this.gl),w=this.gl.getUniformLocation(R,"uScale");this.gl.uniform4fv(w,[1/window.devicePixelRatio,1/window.devicePixelRatio,0,1]);const S=this.gl.getAttribLocation(R,"rectVertexPosition"),T=this.gl.getUniformLocation(R,"u_resolution"),I=this.gl.getUniformLocation(R,"rect_u_size"),E=this.gl.getUniformLocation(R,"rect_u_borderWidth"),A=this.gl.getUniformLocation(R,"rect_u_borderSoftness"),k=this.gl.getUniformLocation(R,"rect_u_borderRadius"),D=this.gl.getUniformLocation(R,"rect_u_backgroundColor"),C=this.gl.getUniformLocation(R,"rect_u_borderColor"),M=this.gl.getUniformLocation(R,"rect_u_location");this.shaders.kinds.border={program:R,attributes:{rectVertexPosition:S},uniforms:{u_resolution:T,rect_u_size:I,rect_u_borderWidth:E,rect_u_borderSoftness:A,rect_u_borderRadius:k,rect_u_backgroundColor:D,rect_u_borderColor:C,rect_u_location:M}}}_render(){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(const e of this.itemsToMergerList)if("video"===e.type){if(!e.renderVideo)continue;if(this._drawVideoBackgroundsAndBorders(e,!1),e.cameraDisabled)e._mitem_state.Avatar_ImageRenderer&&e._mitem_state.Avatar_ImageRenderer.render();else if(e.isVideoReady&&(!e.isReconnecting||!e._mitem_state.Reconnecting_ImageRenderer||!e._mitem_state.Reconnecting_ImageRenderer.isItReady())){const t=e.videoElement,r=e._mitem_state.videoTexture;this.gl.useProgram(this.shaders.kinds.video.program),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t);const i=(0,u.createBuffer)(this.gl,(0,u.calculateVerticesPosition)(this.canvas,{x:e.x,y:e.y,objectFit:e.objectFit,width:e.width,height:e.height,borderWidth:e.borderWidth,imageWidth:e.videoElement.videoWidth,imageHeight:e.videoElement.videoHeight}),this.gl.ARRAY_BUFFER);if((0,u.setBufferData)(this.gl,this.shaders.kinds.video.attributes.rectVertexPosition,i),this.gl.uniform2fv(this.shaders.kinds.video.uniforms.u_resolution,[this.canvas.width,this.canvas.height]),e.borderWidth||e.innerBorder&&e.innerBorder.borderWidth){let t=e.x,r=e.y,i=e.width,o=e.height,n=e.borderRadius;if(n&&(n+=2),n&&!e.borderWidth&&e.innerBorder&&e.innerBorder.borderWidth){const e=2;i-=e,o-=e,t+=e/2,r+=e/2,n-=e}let s=0;e.borderWidth&&(e.borderSoftness&&(s=e.borderSoftness/2,i-=s,o-=s,t+=s/2,r+=s/2),t+=e.borderWidth,r+=e.borderWidth,i-=2*e.borderWidth,o-=2*e.borderWidth,n&&(n-=e.borderWidth)),this.gl.uniform2fv(this.shaders.kinds.video.uniforms.rect_u_size,[i,o]),this.gl.uniform2fv(this.shaders.kinds.video.uniforms.rect_u_location,[t,r]),this.gl.uniform1f(this.shaders.kinds.video.uniforms.rect_u_borderWidth,0),this.gl.uniform1f(this.shaders.kinds.video.uniforms.rect_u_borderSoftness,0),this.gl.uniform4fv(this.shaders.kinds.video.uniforms.rect_u_borderColor,[0,0,0,0]),this.gl.uniform4fv(this.shaders.kinds.video.uniforms.rect_u_borderRadius,[n,n,n,n])}else this.gl.uniform2fv(this.shaders.kinds.video.uniforms.rect_u_size,[e.width,e.height]),this.gl.uniform2fv(this.shaders.kinds.video.uniforms.rect_u_location,[e.x,e.y]),this.gl.uniform1f(this.shaders.kinds.video.uniforms.rect_u_borderWidth,0),this.gl.uniform1f(this.shaders.kinds.video.uniforms.rect_u_borderSoftness,e.borderSoftness),this.gl.uniform4fv(this.shaders.kinds.video.uniforms.rect_u_borderColor,[0,0,0,0]),this.gl.uniform4fv(this.shaders.kinds.video.uniforms.rect_u_borderRadius,[e.borderRadius,e.borderRadius,e.borderRadius,e.borderRadius]);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}e.isReconnecting&&!e._mitem_state.Reconnecting_ImageRenderer&&this._initVideoReconnecting(e),!e.cameraDisabled&&e.isReconnecting&&e._mitem_state.Reconnecting_ImageRenderer&&e._mitem_state.Reconnecting_ImageRenderer.render(),e.audioDisabled?e._mitem_state.DisplayName_WithMutedMic_TextRenderer&&e._mitem_state.DisplayName_WithMutedMic_TextRenderer.render():e._mitem_state.DisplayName_TextRenderer&&e._mitem_state.DisplayName_TextRenderer.render(),(e.isWaiting||e.isReconnecting)&&(this.waiting_animation_ImageRenderer.update({width:e.waitingDimension.width,height:e.waitingDimension.height,x:e.waitingDimension.x,y:e.waitingDimension.y}),this.waiting_animation_ImageRenderer.render({gifGroupName:e.id,gifSessionKey:e.waitingDimension.sessionKey,gifRandomizeInitialization:!0})),this._drawVideoBackgroundsAndBorders(e,!0)}else"text"===e.type&&e._mitem_state.TextItemRenderer&&e._mitem_state.TextItemRenderer.render()}_drawVideoBackgroundsAndBorders(e,t){if(t){if(!e.innerBorder||!e.innerBorder.borderWidth||!e.innerBorder.borderColor)return;this.drawRectBackgroundsAndBorders({width:e.width,height:e.height,x:e.x,y:e.y,parentBorderWidth:e.borderWidth,borderWidth:e.innerBorder.borderWidth,borderColor:e.innerBorder.borderColor,backgroundColor:[0,0,0,0],borderRadius:e.borderRadius,borderSoftness:e.borderSoftness},!0)}else this.drawRectBackgroundsAndBorders({width:e.width,height:e.height,x:e.x,y:e.y,borderWidth:e.borderWidth,borderColor:e.borderColor,backgroundColor:e.backgroundColor,borderRadius:e.borderRadius,borderSoftness:e.borderSoftness},!1)}drawRectBackgroundsAndBorders({width:e,height:t,x:r,y:i,parentBorderWidth:o,borderWidth:n,borderColor:s,backgroundColor:a,borderRadius:d,borderSoftness:c},h){if(h){let a=r,h=i,l=e,m=t,f=d,g=0;o&&(c&&(g=c/2,l+=g,m+=g,a-=g/2,h-=g/2),a+=o,h+=o,l-=2*o,m-=2*o,f&&(f-=o));const _=(0,u.createRectVertices)(this.canvas,{x:a,y:h,width:l,height:m,borderWidth:o}),x=(0,u.createBuffer)(this.gl,_,this.gl.ARRAY_BUFFER);(0,u.setBufferData)(this.gl,this.shaders.kinds.border.attributes.rectVertexPosition,x),this.gl.useProgram(this.shaders.kinds.border.program),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,x),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.u_resolution,[this.canvas.width,this.canvas.height]),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.rect_u_size,[l,m]),this.gl.uniform1f(this.shaders.kinds.border.uniforms.rect_u_borderWidth,n),this.gl.uniform1f(this.shaders.kinds.border.uniforms.rect_u_borderSoftness,c),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_borderRadius,[f,f,f,f]),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_backgroundColor,[0,0,0,0]),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_borderColor,s),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.rect_u_location,[a,h]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,_.length/2)}else{const o=(0,u.createRectVertices)(this.canvas,{x:r,y:i,width:e,height:t,borderWidth:n}),h=(0,u.createBuffer)(this.gl,o,this.gl.ARRAY_BUFFER);(0,u.setBufferData)(this.gl,this.shaders.kinds.border.attributes.rectVertexPosition,h),this.gl.useProgram(this.shaders.kinds.border.program),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.u_resolution,[this.canvas.width,this.canvas.height]),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.rect_u_size,[e,t]),this.gl.uniform1f(this.shaders.kinds.border.uniforms.rect_u_borderWidth,n),this.gl.uniform1f(this.shaders.kinds.border.uniforms.rect_u_borderSoftness,c),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_borderRadius,[d,d,d,d]),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_backgroundColor,a),this.gl.uniform4fv(this.shaders.kinds.border.uniforms.rect_u_borderColor,s),this.gl.uniform2fv(this.shaders.kinds.border.uniforms.rect_u_location,[r,i]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,o.length/2)}}loadTextureAsset({cacheID:e,URL:t},r){if(e||0===e)for(const i of this._cachedTextures.fetchingCaches)if(i.cacheID===e)return void i.awaitings.push({cacheID:e,URL:t,callBack:r});if(e||0===e)for(const t of this._cachedTextures.caches){if(t.cacheID!==e)continue;const i=this.newTextureObject({cacheID:e,linkedID:this.generateIncreamentID(),texture:t.texture.texture,type:t.texture.type,image:t.texture.image});return void r(i)}this._cachedTextures.fetchingCaches.push({cacheID:e,awaitings:[]});const i=(t,r,i)=>{for(const o in this._cachedTextures.fetchingCaches){const n=this._cachedTextures.fetchingCaches[o];if(n.cacheID===e){for(const o of n.awaitings)if(i)o.callBack(null,i);else{const i=this.newTextureObject({cacheID:e,linkedID:this.generateIncreamentID(),texture:r.texture,type:r.type,image:r.image});t.linkedIDs[i.linkedID]={},o.callBack(i)}(0,m.deleteIndex)(this._cachedTextures.fetchingCaches,o);break}}},o=new Image;o.onload=()=>{const t={type:"image",image:o,texture:(0,u.createTexture)(this.gl)};if(e||0===e){const o={cacheID:e,linkedIDs:{},texture:t},n=this.newTextureObject({cacheID:e,linkedID:this.generateIncreamentID(),texture:t.texture,type:t.type,image:t.image});o.linkedIDs[n.linkedID]={},r(n),i(o,t),this._cachedTextures.caches.push(o)}else{const e=this.newTextureObject({texture:t.texture,type:t.type,image:t.image});r(e)}},o.onerror=e=>{r(null,e),i(null,null,e)},o.src=t}unlinkTextureCache(e){if(e&&(e.cacheID||0===e.cacheID))for(const t in this._cachedTextures.caches){const r=this._cachedTextures.caches[t];if(r.cacheID===e.cacheID){if(!r.linkedIDs.hasOwnProperty(e.linkedID))return;if(delete r.linkedIDs[e.linkedID],Object.keys(r.linkedIDs).length)return;(0,m.deleteIndex)(this._cachedTextures.caches,t);break}}}newTextureObject({cacheID:e,linkedID:t,texture:r,type:i,image:o}){return new x({cacheID:e,linkedID:t,texture:r,type:i,image:o})}console(){const e=this.debug;return{throwError(e){throw new Error(e)},log(...t){if(e)return console.log.apply(this,t)},warn(...t){if(e)return console.warn.apply(this,t)},error(...t){if(e)return console.error.apply(this,t)}}}static createImageShaderProgram(e){const t=`\n    precision mediump float;\n    uniform sampler2D uSampler;\n    varying vec2 vUv;\n\n    uniform vec2 u_resolution;\n    uniform vec2 rect_u_location;\n    uniform vec2 rect_u_size;\n    uniform vec4 rect_u_borderRadius;\n    uniform vec4 rect_u_borderColor;\n    uniform float rect_u_borderWidth;\n    uniform float rect_u_borderSoftness;\n\n    void roundedRectBorderEntryPoint(out vec4 fragColor, in vec2 fragCoord, vec2 u_resolution, vec2 u_location, vec2 u_rectSize, float u_borderWidth, vec4 u_colorRect, vec4 u_colorBorder, vec4 u_borderRadius, float u_borderSoftness);\n    void main () {\n      \n      vec4 imgColor = texture2D(uSampler, vUv);\n      vec2 fragCoord = gl_FragCoord.xy;\n\n      roundedRectBorderEntryPoint(gl_FragColor, fragCoord, u_resolution, rect_u_location, rect_u_size, rect_u_borderWidth, imgColor, rect_u_borderColor, rect_u_borderRadius, rect_u_borderSoftness);\n    }\n    ${s.default}\n  `,r=(0,u.createShader)(e,e.VERTEX_SHADER,"\n    attribute vec2 aVertexPosition;\n    attribute vec2 aUv;\n    varying vec2 vUv;\n    uniform vec4 uScale;\n\n    void main () {\n      vUv = aUv;\n      gl_Position = vec4(aVertexPosition, 0, 1) * uScale;\n    }\n  "),i=(0,u.createShader)(e,e.FRAGMENT_SHADER,t);return(0,u.createProgram)(e,r,i)}static createBorderShaderProgram(e){const t=`\n      precision mediump float;\n      uniform vec2 u_resolution;\n      uniform vec2 rect_u_location;\n      uniform vec2 rect_u_size;\n      uniform vec4 rect_u_borderRadius;\n      uniform vec4 rect_u_backgroundColor;\n      uniform vec4 rect_u_borderColor;\n      uniform float rect_u_borderWidth;\n      uniform float rect_u_borderSoftness;\n      varying vec2 rectVertexPositionVarying;\n      \n      void roundedRectBorderEntryPoint(out vec4 fragColor, in vec2 fragCoord, vec2 u_resolution, vec2 u_location, vec2 u_rectSize, float u_borderWidth, vec4 u_colorRect, vec4 u_colorBorder, vec4 u_borderRadius, float u_borderSoftness);\n      void main() {\n        vec2 fragCoord = gl_FragCoord.xy;\n        roundedRectBorderEntryPoint(gl_FragColor, fragCoord, u_resolution, rect_u_location, rect_u_size, rect_u_borderWidth, rect_u_backgroundColor, rect_u_borderColor, rect_u_borderRadius, rect_u_borderSoftness);\n      }\n      \n      ${s.default}\n    `,r=(0,u.createShader)(e,e.VERTEX_SHADER,"\n      attribute vec2 rectVertexPosition;\n      varying vec2 rectVertexPositionVarying;\n      uniform vec4 uScale;\n      void main() {\n        rectVertexPositionVarying = rectVertexPosition; \n        gl_Position = vec4(rectVertexPosition, 0, 1) * uScale;\n      }\n    "),i=(0,u.createShader)(e,e.FRAGMENT_SHADER,t);return(0,u.createProgram)(e,r,i)}_compareObjectsProperties(e,t,r){if(e===t)return!0;if(!e||!t)return!1;const i=(e,t,r,n,s)=>{if(e===t)return!0;if(!e||!t)return!1;if(s&&(!_.valIsObject(e)||!_.valIsObject(t)))return!1;if(_.valIsObject(e)&&_.valIsObject(t))return e[r]===t[n]||(_.valIsObject(e[r])&&_.valIsObject(t[n])?o(e[r],t[n]):!(!_.valIsArray(e[r])||!_.valIsArray(t[n]))&&i(e[r],t[n],null,null));if(_.valIsArray(e)&&_.valIsArray(t)){if(e.length!==t.length)return!1;for(const r in e)if(e[r]!==t[r])if(_.valIsArray(e[r])&&_.valIsArray(t[r])){if(!i(e[r],t[r],null,null))return!1}else{if(!_.valIsObject(e[r])||!_.valIsObject(t[r]))return!1;if(!o(e[r],t[r]))return!1}return!0}return e===t},o=(e,t)=>{if(e===t)return!0;if(!e||!t)return!1;if(!_.valIsObject(e)||!_.valIsObject(t))return!1;const r=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const o of r)if(!i(e,t,o,o))return!1;return!0};for(const o of r)if(o.sameKeys){for(const r of o.sameKeys)if(!i(e,t,r,r,!0))return!1}else if(o.key1&&o.key2&&!i(e,t,o.key1,o.key2,!0))return!1;return!0}static valIsObject(e){return!!(e&&e instanceof Object&&"Object"===e.constructor.name)}static valIsArray(e){return!(!e||!Array.isArray(e))}_destroy(){this._resetFrame([]),this._stopDrawing(),this.MediaAudio&&this.MediaAudio.audioContext.close(),this.destroyed=!0,this.Event.fire("destroy")}}class x{constructor({cacheID:e,linkedID:t,texture:r,type:i,image:o}){this.cacheID=e,this.linkedID=t,this.texture=r,this.type=i,this.image=o}}_.prototype._extensions={},_.prototype.GetExtension=function(e){const t=_.prototype._extensions[e];if(!t)throw new o.default(`No extension with name "${e}" found!`,{code:no_such_extension_found});const r=this;return{New:function(){return t.call(r,[...arguments])}}},_.prototype.Logs={VCVRDEnum:i.default,VCVRDError:o.default};const p=_},"./asset/vc-videos-renderer/images/default-avatar.png":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});const i=r.p+"asset/vc-videos-renderer/images/default-avatar.png"},"./asset/vc-videos-renderer/images/default-reconnecting-avatar.png":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});const i=r.p+"asset/vc-videos-renderer/images/default-reconnecting-avatar.png"},"./asset/vc-videos-renderer/images/muted-mic.png":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});const i=r.p+"asset/vc-videos-renderer/images/muted-mic.png"},"./node_modules/raw-loader/dist/cjs.js!./src/shaders/rounded-rect-border-entry-point.frag":(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});const i="// Source from -> https://www.shadertoy.com/view/fsdyzB\r\n        // Based on shaders from @amine_sebastian and @iq:\r\n        //   - https://www.shadertoy.com/view/WtdSDs\r\n        //   - https://www.shadertoy.com/view/tltXDl\r\n\r\n        // TODO: Shadow 'u_colorShadow.a' is unused; Only used 'u_colorShadow.rgb' components\r\n\r\n        // from https://iquilezles.org/articles/distfunctions\r\n\r\n        float roundedBoxSDF(vec2 CenterPosition, vec2 Size, vec4 Radius){\r\n          Radius.xy = (CenterPosition.x > 0.0) ? Radius.xy : Radius.zw;\r\n          Radius.x  = (CenterPosition.y > 0.0) ? Radius.x  : Radius.y;\r\n          vec2 q = abs(CenterPosition)-Size+Radius.x;\r\n    return min(max(q.x,q.y),0.0) + length(max(q,0.0)) - Radius.x;\r\n}\r\n\r\nvoid roundedRectBorderEntryPoint(out vec4 fragColor, in vec2 fragCoord, vec2 u_resolution, vec2 u_location, vec2 u_rectSize, float u_borderWidth, vec4 u_colorRect, vec4 u_colorBorder, vec4 u_borderRadius, float u_borderSoftness)\r\n{\r\n    // =========================================================================\r\n    // Inputs (uniforms)\r\n\r\n    vec2 uv = fragCoord.xy / u_resolution;\r\n    \r\n    float u_edgeSoftness   = 2.0; // How soft the edges should be (in pixels). Higher values could be used to simulate a drop shadow.\r\n    \r\n    // Border\r\n    vec4  u_cornerRadiuses = u_borderRadius; // The radiuses of the corners(in pixels): [topRight, bottomRight, topLeft, bottomLeft]\r\n    \r\n    \r\n    //float u_borderWidth = 5.0; // The border size (in pixels) \r\n    //float u_borderSoftness  = 1.0; // How soft the (internal) border should be (in pixels)\r\n    \r\n    float boundaryAdjustment = u_borderSoftness;\r\n    //vec2 u_resolution = vec2(620.0, 500.0); // viewport resolution (in pixels)\r\n    u_location = vec2(u_location.x + (boundaryAdjustment / 2.0), u_location.y + (boundaryAdjustment / 2.0)); // rect position (in pixels).\r\n    u_rectSize  = vec2(u_rectSize.x - boundaryAdjustment, u_rectSize.y - boundaryAdjustment); // The pixel-space scale of the rectangle.\r\n\r\n    \r\n    vec2 location = vec2(u_location.x, u_resolution.y - u_rectSize.y - u_location.y);\r\n    \r\n    \r\n    \r\n    // Shadow\r\n    float u_shadowSoftness = 0.0;            // The (half) shadow radius (in pixels)\r\n    //We don't need shadow, we should just hide it instead.\r\n    vec2  u_shadowOffset   = vec2(0.0, u_resolution.x-10.0); // The pixel-space shadow offset from rectangle center\r\n    \r\n    // Colors\r\n    vec4  u_colorBg     = vec4(u_colorRect.rgb, 0.0); // The color of background\r\n    //vec4  u_colorRect   = vec4(1.0,  0.30, 0.45, 0.3); // The color of rectangle\r\n    //vec4  u_colorBorder = vec4(0.7,  0.25, 0.55, 1.0); // The color of (internal) border\r\n    vec4  u_colorShadow = vec4(0.0,  0.0,  0.0,  1.0); // The color of shadow\r\n    \r\n    // =========================================================================\r\n\r\n    vec2 halfSize = (u_rectSize / 2.0); // Rectangle extents (half of the size)\r\n    \r\n    vec4 radius = u_cornerRadiuses; // Animated corners radiuses\r\n    \r\n    // -------------------------------------------------------------------------\r\n    \r\n    // Calculate distance to edge.   \r\n    float distance = roundedBoxSDF(fragCoord.xy - location - (u_rectSize/2.0), halfSize, radius);\r\n       \r\n    // Smooth the result (free antialiasing).\r\n    float smoothedAlpha = 1.0-smoothstep(0.0, u_edgeSoftness, distance);\r\n    \r\n    // -------------------------------------------------------------------------\r\n    // Border.\r\n    \r\n    float borderAlpha   = 1.0-smoothstep(u_borderWidth - u_borderSoftness, u_borderWidth, abs(distance));\r\n    \r\n    // -------------------------------------------------------------------------\r\n    // Apply a drop shadow effect.\r\n    \r\n    float shadowDistance  = roundedBoxSDF(fragCoord.xy - location + u_shadowOffset - (u_rectSize/2.0), halfSize, radius);\r\n    float shadowAlpha \t  = 1.0-smoothstep(-u_shadowSoftness, u_shadowSoftness, shadowDistance);\r\n    \r\n\r\n    // -------------------------------------------------------------------------\r\n    // Debug output\r\n    \r\n        // vec4 debug_sdf = vec4(distance, 0.0, 0.0, 1.0);\r\n    \r\n        // Notice, that instead simple 'alpha' here is used 'min(u_colorRect.a, alpha)' to enable transparency\r\n        // vec4 debug_rect_color   = mix(u_colorBg, u_colorRect, min(u_colorRect.a, smoothedAlpha));\r\n    \r\n        // Notice, that instead simple 'alpha' here is used 'min(u_colorBorder.a, alpha)' to enable transparency\r\n        // vec4 debug_border_color = mix(u_colorBg, u_colorBorder, min(u_colorBorder.a, min(borderAlpha, smoothedAlpha)) ); \r\n\r\n    // -------------------------------------------------------------------------\r\n    // Apply colors layer-by-layer: background <- shadow <- rect <- border.\r\n    \r\n    // Blend background with shadow\r\n    vec4 res_shadow_color = mix(u_colorBg, vec4(u_colorShadow.rgb, shadowAlpha), shadowAlpha);\r\n\r\n    // Blend (background+shadow) with rect\r\n    //   Note:\r\n    //     - Used 'min(u_colorRect.a, smoothedAlpha)' instead of 'smoothedAlpha'\r\n    //       to enable rectangle color transparency\r\n    vec4 res_shadow_with_rect_color = \r\n        mix(\r\n            res_shadow_color,\r\n            u_colorRect,\r\n            min(u_colorRect.a, smoothedAlpha)\r\n        );\r\n        \r\n    // Blend (background+shadow+rect) with border\r\n    //   Note:\r\n    //     - Used 'min(borderAlpha, smoothedAlpha)' instead of 'borderAlpha'\r\n    //       to make border 'internal'\r\n    //     - Used 'min(u_colorBorder.a, alpha)' instead of 'alpha' to enable\r\n    //       border color transparency\r\n    vec4 res_shadow_with_rect_with_border =\r\n        mix(\r\n            res_shadow_with_rect_color,\r\n            u_colorBorder,\r\n            min(u_colorBorder.a, min(borderAlpha, smoothedAlpha))\r\n        );\r\n    \r\n    // -------------------------------------------------------------------------\r\n     \r\n    fragColor = res_shadow_with_rect_with_border.rgba;\r\n}\r\n      "},"./node_modules/regenerator-runtime/runtime.js":e=>{var t=function(e){"use strict";var t,r=Object.prototype,i=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},n="function"==typeof Symbol?Symbol:{},s=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",d=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function h(e,t,r,i){var n=t&&t.prototype instanceof x?t:x,s=Object.create(n.prototype),a=new D(i||[]);return o(s,"_invoke",{value:I(e,r,a)}),s}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=h;var u="suspendedStart",m="suspendedYield",f="executing",g="completed",_={};function x(){}function p(){}function v(){}var y={};c(y,s,(function(){return this}));var b=Object.getPrototypeOf,R=b&&b(b(C([])));R&&R!==r&&i.call(R,s)&&(y=R);var w=v.prototype=x.prototype=Object.create(y);function S(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function r(o,n,s,a){var d=l(e[o],e,n);if("throw"!==d.type){var c=d.arg,h=c.value;return h&&"object"==typeof h&&i.call(h,"__await")?t.resolve(h.__await).then((function(e){r("next",e,s,a)}),(function(e){r("throw",e,s,a)})):t.resolve(h).then((function(e){c.value=e,s(c)}),(function(e){return r("throw",e,s,a)}))}a(d.arg)}var n;o(this,"_invoke",{value:function(e,i){function o(){return new t((function(t,o){r(e,i,t,o)}))}return n=n?n.then(o,o):o()}})}function I(e,r,i){var o=u;return function(n,s){if(o===f)throw new Error("Generator is already running");if(o===g){if("throw"===n)throw s;return{value:t,done:!0}}for(i.method=n,i.arg=s;;){var a=i.delegate;if(a){var d=E(a,i);if(d){if(d===_)continue;return d}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(o===u)throw o=g,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);o=f;var c=l(e,r,i);if("normal"===c.type){if(o=i.done?g:m,c.arg===_)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(o=g,i.method="throw",i.arg=c.arg)}}}function E(e,r){var i=r.method,o=e.iterator[i];if(o===t)return r.delegate=null,"throw"===i&&e.iterator.return&&(r.method="return",r.arg=t,E(e,r),"throw"===r.method)||"return"!==i&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+i+"' method")),_;var n=l(o,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,_;var s=n.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,_):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,_)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function C(e){if(null!=e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,n=function r(){for(;++o<e.length;)if(i.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return n.next=n}}throw new TypeError(typeof e+" is not iterable")}return p.prototype=v,o(w,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:p,configurable:!0}),p.displayName=c(v,d,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,c(e,d,"GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},S(T.prototype),c(T.prototype,a,(function(){return this})),e.AsyncIterator=T,e.async=function(t,r,i,o,n){void 0===n&&(n=Promise);var s=new T(h(t,r,i,o),n);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(w),c(w,d,"Generator"),c(w,s,(function(){return this})),c(w,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var i in t)r.push(i);return r.reverse(),function e(){for(;r.length;){var i=r.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},e.values=C,D.prototype={constructor:D,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&i.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(i,o){return a.type="throw",a.arg=e,r.next=i,o&&(r.method="next",r.arg=t),!!o}for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var d=i.call(s,"catchLoc"),c=i.call(s,"finallyLoc");if(d&&c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(d){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var s=n?n.completion:{};return s.type=e,s.arg=t,n?(this.method="next",this.next=n.finallyLoc,_):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),_},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),_}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var o=i.arg;k(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,i){return this.delegate={iterator:C(e),resultName:r,nextLoc:i},"next"===this.method&&(this.arg=t),_}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}},"./env.json":e=>{"use strict";e.exports={publicPath:"/"}}},t={};function r(i){var o=t[i];if(void 0!==o)return o.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}return r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="/",r("./node_modules/regenerator-runtime/runtime.js"),r("./src/index.js")})()));
//# sourceMappingURL=vc-videos-renderer.js.map